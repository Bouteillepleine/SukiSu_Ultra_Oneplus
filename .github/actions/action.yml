name: Build OnePlus Kernel with SukiSU Ultra

inputs:
  model:
    description: 'Device model code'
    required: true
  soc:
    description: 'SoC platform'
    required: true
  branch:
    description: 'Kernel source branch'
    required: true
  manifest:
    description: 'Repo manifest file or URL'
    required: true
  android_version:
    description: 'Android version (e.g., android14)'
    required: true
  kernel_version:
    description: 'Kernel version (e.g., 6.1)'
    required: true
  susfs_branch:
    description: 'SUSFS branch (auto-resolved if empty)'
    required: false
    default: ''
  KSU_META:
    description: 'SukiSU Ultra metadata (branch/tag/hash)'
    required: false
    default: 'susfs-main/⚡Ultra⚡/'
  HOOK:
    description: 'Hook type (kprobe/manual/tracepoint)'
    required: false
    default: 'manual'
  LSM:
    description: 'Enable Baseband Guard LSM (true/false)'
    required: false
    default: 'false'
  optimize_level:
    description: 'Optimization level (O2/O3)'
    required: false
    default: 'O2'
  github_token:
    description: 'GitHub token for API access'
    required: true

outputs:
  kernel_version:
    description: 'Built kernel version'
    value: ${{ steps.stats.outputs.kernel_version }}
  ksu_version:
    description: 'KernelSU version'
    value: ${{ steps.save_metadata.outputs.ksu_version }}
  susfs_version:
    description: 'SUSFS version'
    value: ${{ steps.save_metadata.outputs.susfs_version }}
  image_sha256:
    description: 'Kernel image SHA256'
    value: ${{ steps.stats.outputs.image_sha256 }}
  package_name:
    description: 'Package filename (without .zip)'
    value: ${{ steps.package.outputs.name }}
  artifact_name:
    description: 'Artifact name (for download)'
    value: ${{ steps.package.outputs.artifact_name }}
  package_size:
    description: 'Package size in MB'
    value: ${{ steps.package.outputs.size }}
  path:
    description: 'Full path to package zip'
    value: ${{ steps.package.outputs.path }}
  filename:
    description: 'Package filename (with .zip)'
    value: ${{ steps.package.outputs.filename }}
  release_tag:
    description: 'Release tag name'
    value: ${{ steps.generate_tag.outputs.tag }}

runs:
  using: composite
  steps:
    - name: Validate Inputs
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Validate inputs"
        
        # Check required variables
        for var in MODEL SOC BRANCH MANIFEST ANDROID_VERSION KERNEL_VERSION OPTIMIZE_LEVEL; do
          val="${!var:-}"
          if [[ -z "$val" ]]; then
            echo "::error::${var} is required"
            exit 1
          fi
        done
        
        # Validate SoC format
        if ! [[ "$SOC" =~ ^[A-Za-z0-9_-]+$ ]]; then
          echo "::error::soc contains invalid characters"
          exit 1
        fi
        
        # Validate branch format
        if ! [[ "$BRANCH" =~ ^[A-Za-z0-9._/-]+$ ]]; then
          echo "::error::branch contains invalid characters"
          exit 1
        fi
        
        # Validate manifest
        if [[ "$MANIFEST" == http*://* ]]; then
          [[ "$MANIFEST" =~ ^https:// ]] || { echo "::error::Manifest must be HTTPS"; exit 1; }
          [[ "$MANIFEST" =~ .xml($|?) ]] || { echo "::error::Manifest must be XML"; exit 1; }
        else
          [[ "$MANIFEST" =~ .xml$ ]] || { echo "::error::Manifest must end with .xml"; exit 1; }
          [[ ! "$MANIFEST" =~ [[:space:]] ]] || { echo "::error::Manifest cannot contain spaces"; exit 1; }
        fi
        
        # Validate optimization level
        case "$OPTIMIZE_LEVEL" in
          O2|O3) ;;
          *) echo "::error::optimize_level must be O2 or O3"; exit 1 ;;
        esac
        
        # Validate hook type
        case "$HOOK" in
          kprobe|manual|tracepoint) ;;
          *) echo "::error::Invalid hook type: $HOOK"; exit 1 ;;
        esac
        
        # Validate LSM flag
        case "$LSM" in
          true|false) ;;
          *) echo "::error::LSM must be 'true' or 'false'"; exit 1 ;;
        esac
        
        echo "✅ Input validation passed"
        echo "::endgroup::"
      env:
        MODEL: ${{ inputs.model }}
        SOC: ${{ inputs.soc }}
        BRANCH: ${{ inputs.branch }}
        MANIFEST: ${{ inputs.manifest }}
        ANDROID_VERSION: ${{ inputs.android_version }}
        KERNEL_VERSION: ${{ inputs.kernel_version }}
        OPTIMIZE_LEVEL: ${{ inputs.optimize_level }}
        HOOK: ${{ inputs.HOOK }}
        LSM: ${{ inputs.LSM }}

    - name: Setup Environment
      shell: bash
      run: |
        set -euo pipefail
        echo "KANDROID_VERSION=${{ inputs.android_version }}" >> "$GITHUB_ENV"
        echo "INPUT_KERNEL_VERSION=${{ inputs.kernel_version }}" >> "$GITHUB_ENV"
        echo "CONFIG=${{ inputs.model }}" >> "$GITHUB_ENV"
        echo "BUILD_DATE=$(date -u +%Y%m%d)" >> "$GITHUB_ENV"
        echo "MIN_IMAGE_SIZE_MB=10" >> "$GITHUB_ENV"

    - name: Install Dependencies
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Install dependencies"
        
        sudo apt-get -o Acquire::Retries=3 update -qq
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
          git curl ca-certificates build-essential clang lld flex bison \
          libelf-dev libssl-dev libncurses-dev zlib1g-dev liblz4-tool \
          libxml2-utils rsync unzip dwarves file python3 jq llvm repo
        sudo apt-get clean
        
        echo "::endgroup::"

    - name: Configure Git
      shell: bash
      run: |
        git config --global user.name "Bouteille"
        git config --global user.email "Bouteille@qq.com"
        git config --global advice.detachedHead false

    - name: Setup Repo Tool
      shell: bash
      run: |
        set -euo pipefail
        REPO="/usr/local/bin/repo"
        if [ ! -x "$REPO" ]; then
          curl -s https://storage.googleapis.com/git-repo-downloads/repo -o "$REPO"
          chmod +x "$REPO"
        fi
        echo "REPO=$REPO" >> "$GITHUB_ENV"

    - name: Clone AnyKernel3
      shell: bash
      run: |
        set -euo pipefail
        
        if ! git clone https://github.com/Bouteillepleine/AnyKernel3.git \
          -b gki-2.0 --depth=1 --single-branch 2>/dev/null; then
          
          echo "::warning::HTTPS clone failed, trying git:// protocol"
          git clone git://github.com/Bouteillepleine/AnyKernel3.git \
            -b gki-2.0 --depth=1 --single-branch
        fi

    - name: Prepare Manifest Fallback
      shell: bash
      run: |
        set -euo pipefail
        mkdir -p "$GITHUB_WORKSPACE/.repo/manifests_fallback"
        
        if [[ "$MANIFEST" == https://* ]]; then
          FILE_BASENAME="custom_$MODEL"
          curl -Ls "$MANIFEST" -o "$GITHUB_WORKSPACE/.repo/manifests_fallback/${FILE_BASENAME}.xml"
          echo "FILE=${FILE_BASENAME}" >> "$GITHUB_ENV"
        else
          FILE_BASENAME="$MANIFEST"
          if [[ "$FILE_BASENAME" == *.xml ]]; then
            echo "FILE=${FILE_BASENAME%.xml}" >> "$GITHUB_ENV"
          else
            echo "FILE=${FILE_BASENAME}" >> "$GITHUB_ENV"
          fi
        fi
      env:
        MANIFEST: ${{ inputs.manifest }}
        MODEL: ${{ inputs.model }}

    - name: Initialize Kernel Source
      shell: bash
      run: |
        set -euo pipefail
        mkdir -p "$CONFIG"
        cd "$CONFIG"
        
        export REPO_TRACE=0
        
        echo "Initializing kernel repo..."
        if [[ "$MANIFEST" == https://* ]]; then
          mkdir -p .repo/manifests
          curl -Ls "$MANIFEST" -o .repo/manifests/temp_manifest.xml
          "$REPO" init -u https://github.com/OnePlusOSS/kernel_manifest.git \
            -b "oneplus/$SOC" -m temp_manifest.xml \
            --repo-rev=v2.16 --depth=1 --no-clone-bundle --no-tags
        else
          "$REPO" init -u https://github.com/OnePlusOSS/kernel_manifest.git \
            -b "$BRANCH" -m "$MANIFEST" \
            --repo-rev=v2.16 --depth=1 --no-clone-bundle --no-tags
        fi
        
        echo "Syncing sources..."
        "$REPO" sync -c --no-clone-bundle --no-tags --optimized-fetch -j$(nproc) --fail-fast
      env:
        CONFIG: ${{ inputs.model }}
        MANIFEST: ${{ inputs.manifest }}
        SOC: ${{ inputs.soc }}
        BRANCH: ${{ inputs.branch }}
        REPO: ${{ env.REPO }}

    - name: Mirror Manifest
      if: ${{ inputs.manifest != '' && !startsWith(inputs.manifest, 'https://') }}
      shell: bash
      run: |
        mkdir -p "$GITHUB_WORKSPACE/.repo/manifests_fallback"
        SRC="$GITHUB_WORKSPACE/$CONFIG/.repo/manifests/$MANIFEST"
        [ -f "$SRC" ] && cp -f "$SRC" "$GITHUB_WORKSPACE/.repo/manifests_fallback/$MANIFEST"
      env:
        CONFIG: ${{ inputs.model }}
        MANIFEST: ${{ inputs.manifest }}

    - name: Clean ABI Exports
      shell: bash
      run: |
        cd "$CONFIG/kernel_platform"
        rm -f common/android/abi_gki_protected_exports_* 2>/dev/null || true
        rm -f msm-kernel/android/abi_gki_protected_exports_* 2>/dev/null || true
      env:
        CONFIG: ${{ inputs.model }}

    - name: Detect Kernel Version
      shell: bash
      run: |
        set -euo pipefail
        cd "$CONFIG/kernel_platform/common"
        
        V=$(grep -m1 '^VERSION *=' Makefile | awk '{print $3}' || echo "0")
        P=$(grep -m1 '^PATCHLEVEL *=' Makefile | awk '{print $3}' || echo "0")
        S=$(grep -m1 '^SUBLEVEL *=' Makefile | awk '{print $3}' || echo "0")
        
        echo "DETECTED_KERNEL_VERSION=$V.$P.$S" >> "$GITHUB_ENV"
        echo "Detected kernel version: $V.$P.$S"
      env:
        CONFIG: ${{ inputs.model }}

    - name: Resolve SUSFS Branch
      shell: bash
      run: |
        set -euo pipefail
        
        if [[ -n "$SUSFS_BRANCH_INPUT" ]]; then
          SUSFS_BRANCH="$SUSFS_BRANCH_INPUT"
          echo "Using provided SUSFS branch: $SUSFS_BRANCH"
        else
          declare -A map=(
            ["android12-5.10"]="gki-android12-5.10"
            ["android13-5.10"]="gki-android13-5.10"
            ["android13-5.15"]="gki-android13-5.15"
            ["android14-5.15"]="gki-android14-5.15"
            ["android14-6.1"]="gki-android14-6.1"
            ["android15-6.6"]="gki-android15-6.6"
          )
          
          key="${KANDROID_VERSION}-${INPUT_KERNEL_VERSION}"
          
          if [[ -z "${map[$key]+_}" ]]; then
            echo "::error::Unsupported Android/Kernel combo: $key"
            exit 1
          fi
          
          SUSFS_BRANCH="${map[$key]}"
          echo "Auto-resolved SUSFS branch: $SUSFS_BRANCH"
        fi
        
        echo "SUSFS_KERNEL_BRANCH=$SUSFS_BRANCH" >> "$GITHUB_ENV"
      env:
        SUSFS_BRANCH_INPUT: ${{ inputs.susfs_branch }}
        KANDROID_VERSION: ${{ inputs.android_version }}
        INPUT_KERNEL_VERSION: ${{ inputs.kernel_version }}

    - name: Set Branding
      shell: bash
      run: |
        echo "CUSTOM_LOCALVERSION=-${KANDROID_VERSION}-OnePlus-UltraBolt" >> "$GITHUB_ENV"
      env:
        KANDROID_VERSION: ${{ inputs.android_version }}

    - name: Add SukiSU Ultra
      shell: bash
      run: |
        set -euo pipefail
        export LC_ALL=C.UTF-8
        
        cd "$CONFIG/kernel_platform"
        
        IFS='/' read -r BRANCH_NAME CUSTOM_TAG MANUAL_HASH <<< "$KSU_META"
        [[ -z "$BRANCH_NAME" ]] && BRANCH_NAME="susfs-main"
        
        echo "KSU_BRANCH=$BRANCH_NAME" >> "$GITHUB_ENV"
        
        curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" -o /tmp/sukisu_setup.sh
        bash /tmp/sukisu_setup.sh "$BRANCH_NAME"
        
        cd ./KernelSU
        
        if [[ -n "$MANUAL_HASH" ]]; then
          git fetch origin "$BRANCH_NAME" --depth=50
          git checkout "$MANUAL_HASH"
        fi
        
        KSU_VERSION=$(expr $(git rev-list --count main 2>/dev/null || echo 13000) + 10700)
        echo "KSUVER=$KSU_VERSION" >> "$GITHUB_ENV"
      env:
        CONFIG: ${{ inputs.model }}
        KSU_META: ${{ inputs.KSU_META }}

    - name: Apply SUSFS Patches
      id: susfs_patch
      shell: bash
      run: |
        set -euo pipefail
        cd "$CONFIG"
        
        git clone https://gitlab.com/simonpunk/susfs4ksu.git -b "$SUSFS_KERNEL_BRANCH" --depth=1
        git clone https://github.com/ShirkNeko/SukiSU_patch.git --depth=1
        
        cd kernel_platform
        
        PATCH_FILE="50_add_susfs_in_gki-${KANDROID_VERSION}-${INPUT_KERNEL_VERSION}.patch"
        
        cp "../susfs4ksu/kernel_patches/$PATCH_FILE" ./common/
        cp -r ../susfs4ksu/kernel_patches/fs/* ./common/fs/
        cp -r ../susfs4ksu/kernel_patches/include/linux/* ./common/include/linux/
        
        cd ./common
        
        GKI_V="${KANDROID_VERSION}-${INPUT_KERNEL_VERSION}"
        SUBLEVEL=$(grep '^SUBLEVEL *=' Makefile | head -n1 | cut -d= -f2 | tr -d ' ' || echo "0")
        
        # Apply legacy fix for Android 13 5.15 kernels with SUBLEVEL < 123
        if [ "$GKI_V" = "android13-5.15" ] && [ "$SUBLEVEL" -lt 123 ]; then
          curl -Lo fix_5.15.legacy.patch --retry 5 \
            https://raw.githubusercontent.com/Numbersf/Action-Build/SukiSU-Ultra/patches/fix_5.15.legacy
          patch -p1 < fix_5.15.legacy.patch
        fi
        
        # Special handling for kernel 6.6
        if [[ "$INPUT_KERNEL_VERSION" = "6.6" ]]; then
          if ! grep -q 'common-modules/trusty' "$GITHUB_WORKSPACE/.repo/manifests_fallback/${FILE}.xml" 2>/dev/null; then
            if [[ "$(printf '%s\n' "$DETECTED_KERNEL_VERSION" "6.6.30" | sort -V | head -n1)" = "$DETECTED_KERNEL_VERSION" ]]; then
              sed -i 's/-32,12 +32,38/-32,11 +32,37/g' "$PATCH_FILE"
              sed -i '/#include <trace\/hooks\/fs.h>/d' "$PATCH_FILE"
            fi
          fi
        fi
        
        # Apply SUSFS patch with fallback to 3-way merge
        if ! patch -p1 -F 3 --no-backup-if-mismatch < "$PATCH_FILE"; then
          git init >/dev/null 2>&1 || true
          git add -A
          git commit -qm base || true
          git apply --3way "../susfs4ksu/kernel_patches/$PATCH_FILE"
        fi
      env:
        CONFIG: ${{ inputs.model }}
        SUSFS_KERNEL_BRANCH: ${{ env.SUSFS_KERNEL_BRANCH }}
        KANDROID_VERSION: ${{ inputs.android_version }}
        INPUT_KERNEL_VERSION: ${{ inputs.kernel_version }}
        DETECTED_KERNEL_VERSION: ${{ env.DETECTED_KERNEL_VERSION }}
        FILE: ${{ env.FILE }}

    - name: Upload Patch Rejects
      if: failure() && steps.susfs_patch.conclusion == 'failure'
      uses: actions/upload-artifact@v4
      with:
        name: patch-rejects-${{ inputs.model }}
        path: ${{ inputs.model }}/kernel_platform/common/**/*.rej
        if-no-files-found: ignore
        retention-days: 7

    - name: Record SUSFS Version
      shell: bash
      run: |
        cd "$CONFIG/susfs4ksu"
        SUSVER=$(git rev-parse --short HEAD || echo "unknown")
        echo "SUSVER=$SUSVER" >> "$GITHUB_ENV"
      env:
        CONFIG: ${{ inputs.model }}

    - name: Apply Hide Patches
      shell: bash
      run: |
        set -euo pipefail
        cd "$CONFIG/kernel_platform/common"
        cp ../../SukiSU_patch/69_hide_stuff.patch ./
        patch -p1 -F 3 < 69_hide_stuff.patch
      env:
        CONFIG: ${{ inputs.model }}

    - name: Apply Hook
      shell: bash
      run: |
        set -euo pipefail
        cd "$CONFIG/kernel_platform/common"
        
        case "$HOOK" in
          kprobe)
            echo "HOOK_TYPE=kprobe" >> "$GITHUB_ENV"
            ;;
          manual)
            cp ../../SukiSU_patch/hooks/scope_min_manual_hooks_v1.5.patch ./
            patch -p1 -F 3 < scope_min_manual_hooks_v1.5.patch
            echo "HOOK_TYPE=manual" >> "$GITHUB_ENV"
            ;;
          tracepoint)
            cp ../../SukiSU_patch/hooks/sukisu_tracepoint_hooks_v1.1.patch ./
            patch -p1 -F 3 < sukisu_tracepoint_hooks_v1.1.patch
            echo "HOOK_TYPE=tracepoint" >> "$GITHUB_ENV"
            ;;
        esac
      env:
        CONFIG: ${{ inputs.model }}
        HOOK: ${{ inputs.HOOK }}

    - name: Apply LSM
      if: ${{ inputs.LSM == 'true' }}
      shell: bash
      run: |
        set -euo pipefail
        cd "$CONFIG/kernel_platform/common"
        
        curl -LSs https://raw.githubusercontent.com/vc-teahouse/Baseband-guard/main/setup.sh -o /tmp/bbg_setup.sh
        bash /tmp/bbg_setup.sh
        
        if grep -q '^config LSM' security/Kconfig; then
          if awk '/^config LSM$/{f=1} f && /default/{print; exit}' security/Kconfig | grep -q 'lockdown'; then
            sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/lockdown/lockdown,baseband_guard/ } }' security/Kconfig
          else
            sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/bpf/bpf,baseband_guard/ } }' security/Kconfig
          fi
        fi
      env:
        CONFIG: ${{ inputs.model }}

    - name: Apply HMBIRD Patch (6.6)
      if: ${{ inputs.kernel_version == '6.6' }}
      shell: bash
      run: |
        set -euo pipefail
        cd "$CONFIG/kernel_platform/common"
        
        curl -fL -o hmbird_patch.patch \
          https://raw.githubusercontent.com/Numbersf/Action-Build/SukiSU-Ultra/patches/hmbird_patch.patch
        
        grep -q 'hmbird_patch.o' drivers/Makefile || \
          echo 'obj-y += hmbird_patch.o' >> drivers/Makefile
        
        patch -p1 -F 3 < hmbird_patch.patch || true
      env:
        CONFIG: ${{ inputs.model }}

    - name: Configure Kernel
      shell: bash
      run: |
        set -euo pipefail
        cd "$CONFIG/kernel_platform"
        
        CONFIG_FILE=./common/arch/arm64/configs/gki_defconfig
        
        # Core KernelSU & SUSFS
        cat >> "$CONFIG_FILE" << 'EOF'
        CONFIG_KSU=y
        CONFIG_KPM=y
        CONFIG_KSU_SUSFS=y
        CONFIG_KSU_SUSFS_SUS_PATH=y
        CONFIG_KSU_SUSFS_SUS_MAP=y
        CONFIG_KSU_SUSFS_SUS_MOUNT=y
        CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y
        CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y
        CONFIG_KSU_SUSFS_SUS_KSTAT=y
        CONFIG_KSU_SUSFS_SUS_OVERLAYFS=n
        CONFIG_KSU_SUSFS_TRY_UMOUNT=y
        CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y
        CONFIG_KSU_SUSFS_SPOOF_UNAME=y
        CONFIG_KSU_SUSFS_ENABLE_LOG=y
        CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
        CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
        CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
        EOF
        
        # Hook configuration
        case "$HOOK" in
          kprobe)
            cat >> "$CONFIG_FILE" << 'EOF'
        CONFIG_KSU_SUSFS_SUS_SU=y
        CONFIG_KPROBES=y
        CONFIG_KSU_KPROBES_HOOK=y
        EOF
            ;;
          manual)
            cat >> "$CONFIG_FILE" << 'EOF'
        CONFIG_KSU_SUSFS_SUS_SU=n
        CONFIG_KSU_MANUAL_HOOK=y
        EOF
            ;;
          tracepoint)
            cat >> "$CONFIG_FILE" << 'EOF'
        CONFIG_KSU_SUSFS_SUS_SU=n
        CONFIG_KSU_TRACEPOINT_HOOK=y
        EOF
            ;;
        esac
        
        # Network & Performance
        cat >> "$CONFIG_FILE" << 'EOF'
        # Network Scheduling
        CONFIG_NET_SCHED=y
        CONFIG_NET_SCH_INGRESS=y
        CONFIG_NET_FLOW_LIMIT=y        
        # TCP Congestion Control - BBR
        CONFIG_TCP_CONG_ADVANCED=y
        CONFIG_TCP_CONG_BBR=y
        CONFIG_TCP_CONG_CUBIC=y        
        # Queue Disciplines
        CONFIG_NET_SCH_FQ=y
        CONFIG_NET_SCH_FQ_CODEL=y        
        # TCP FastOpen
        CONFIG_TCP_FASTOPEN=y
        CONFIG_TCP_FASTOPEN_DEFAULT=3        
        # ECN Support
        CONFIG_IP_ECN=y
        CONFIG_TCP_ECN=y
        CONFIG_IPV6_ECN=y
        CONFIG_IP_NF_TARGET_ECN=y        
        # TCP Optimizations
        CONFIG_TCP_RACK=y
        CONFIG_TCP_TLP=y        
        # Network Performance
        CONFIG_RPS=y
        CONFIG_RFS_ACCEL=y
        CONFIG_XPS=y
        CONFIG_GRO_CELLS=y
        CONFIG_XFRM_OFFLOAD=y        
        # TTL/HL Manipulation
        CONFIG_IP_NF_TARGET_TTL=y
        CONFIG_IP6_NF_TARGET_HL=y
        CONFIG_IP6_NF_MATCH_HL=y    
        # Advanced Routing
        CONFIG_IP_ADVANCED_ROUTER=y
        CONFIG_IP_MULTIPLE_TABLES=y
        CONFIG_NETFILTER_XTABLES=y
        # Netfilter Extensions
        CONFIG_NETFILTER_XT_TARGET_TCPMSS=y
        CONFIG_NETFILTER_XT_MATCH_TTL=y        
        # IP Set Framework
        CONFIG_IP_SET=y
        CONFIG_IP_SET_MAX=65534    
        # Bitmap Types
        CONFIG_IP_SET_BITMAP_IP=y
        CONFIG_IP_SET_BITMAP_IPMAC=y
        CONFIG_IP_SET_BITMAP_PORT=y        
        # Hash Types
        CONFIG_IP_SET_HASH_IP=y
        CONFIG_IP_SET_HASH_IPMARK=y
        CONFIG_IP_SET_HASH_IPPORT=y
        CONFIG_IP_SET_HASH_IPPORTIP=y
        CONFIG_IP_SET_HASH_IPPORTNET=y
        CONFIG_IP_SET_HASH_IPMAC=y
        CONFIG_IP_SET_HASH_MAC=y
        CONFIG_IP_SET_HASH_NETPORTNET=y
        CONFIG_IP_SET_HASH_NET=y
        CONFIG_IP_SET_HASH_NETNET=y
        CONFIG_IP_SET_HASH_NETPORT=y
        CONFIG_IP_SET_HASH_NETIFACE=y    
        # List Type
        CONFIG_IP_SET_LIST_SET=y      
        # Link Time Optimization
        CONFIG_LTO_CLANG_THIN=y
        CONFIG_LTO_CLANG=y    
        # Linker Optimizations
        CONFIG_LD_DEAD_CODE_DATA_ELIMINATION=y    
        # Power Efficiency
        CONFIG_WQ_POWER_EFFICIENT_DEFAULT=y       
        # Disable Kernel Debugging
        CONFIG_DEBUG_KERNEL=n
        CONFIG_DEBUG_INFO=n
        CONFIG_DEBUG_INFO_DWARF4=n       
        # Disable Lock Debugging
        CONFIG_LOCK_DEBUGGING=n
        CONFIG_DEBUG_MUTEXES=n
        CONFIG_DEBUG_SPINLOCK=n
        CONFIG_DEBUG_ATOMIC_SLEEP=n
        EOF
        
        # Optimization level - set correctly based on input
        if [ "$OPTIMIZE_LEVEL" = "O3" ]; then
          cat >> "$CONFIG_FILE" << 'EOF'
        # Compiler Optimizations - O3
        CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=n
        CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE_O3=y
        CONFIG_OPTIMIZE_INLINING=y
        EOF
        else
          cat >> "$CONFIG_FILE" << 'EOF'
        # Compiler Optimizations - O2
        CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y
        CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE_O3=n
        CONFIG_OPTIMIZE_INLINING=y
        EOF
        fi
        
        # LSM (optional)
        [ "$LSM" = "true" ] && echo "CONFIG_BBG=y" >> "$CONFIG_FILE"
      env:
        CONFIG: ${{ inputs.model }}
        HOOK: ${{ inputs.HOOK }}
        LSM: ${{ inputs.LSM }}
        OPTIMIZE_LEVEL: ${{ inputs.optimize_level }}

    - name: Add sched_ext (6.6)
      if: ${{ inputs.kernel_version == '6.6' }}
      shell: bash
      run: |
        set -euo pipefail
        cd "$CONFIG/kernel_platform"
        
        # Clone sched_ext repository
        if ! git clone https://github.com/HanKuCha/sched_ext.git --depth=1 2>&1; then
          echo "::error::Failed to clone sched_ext repository"
          exit 1
        fi
        
        # Copy files (glob pattern excludes .git automatically)
        if ! cp -r sched_ext/* ./common/kernel/sched/ 2>&1; then
          echo "::error::Failed to copy sched_ext files"
          exit 1
        fi
        
        # Clean up entire cloned directory
        rm -rf sched_ext
        
        echo "✅ sched_ext applied successfully"
      env:
        CONFIG: ${{ inputs.model }}

    - name: Save Metadata
      id: save_metadata
      shell: bash
      run: |
        mkdir -p "$GITHUB_WORKSPACE/$CONFIG/artifacts"
        
        printf "kernel_version=%s\n" "${DETECTED_KERNEL_VERSION}" >> "$GITHUB_OUTPUT"
        printf "ksu_version=%s\n" "${KSUVER}" >> "$GITHUB_OUTPUT"
        printf "susfs_version=%s\n" "${SUSVER}" >> "$GITHUB_OUTPUT"
      env:
        CONFIG: ${{ inputs.model }}
        DETECTED_KERNEL_VERSION: ${{ env.DETECTED_KERNEL_VERSION }}
        KSUVER: ${{ env.KSUVER }}
        SUSVER: ${{ env.SUSVER }}

    - name: Detect Clang
      shell: bash
      run: |
        set -euo pipefail
        
        KP="$GITHUB_WORKSPACE/$CONFIG/kernel_platform"
        CLANG_FOUND=false
        
        # Search for prebuilt clang
        for base in "$KP/prebuilts" "$KP/prebuilts-master"; do
          [ -d "$base/clang/host/linux-x86" ] || continue
          latest=$(ls -d "$base/clang/host/linux-x86/clang-r*/" 2>/dev/null | sort -V | tail -n1 || true)
          if [ -n "$latest" ] && [ -x "$latest/bin/clang" ]; then
            CLANG_BIN="$latest/bin"
            CLANG_FOUND=true
            break
          fi
        done
        
        # Fallback to system clang
        if ! $CLANG_FOUND && command -v clang >/dev/null 2>&1; then
          CLANG_BIN="$(dirname "$(command -v clang)")"
          CLANG_FOUND=true
        fi
        
        [ "$CLANG_FOUND" = "false" ] && { echo "::error::No clang found"; exit 1; }
        
        echo "CLANG_BIN_PATH=$CLANG_BIN" >> "$GITHUB_ENV"
        echo "Found clang at: $CLANG_BIN"
      env:
        CONFIG: ${{ inputs.model }}

    - name: Build Kernel
      id: build
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Build kernel"
        
        cd "$GITHUB_WORKSPACE/$CONFIG/kernel_platform/common"
        
        # Disable SCM versioning
        : > .scmversion
        sed -i 's/scm_version="$(scm_version --short)"/scm_version=""/' scripts/setlocalversion
        
        # Setup build environment
        export PYTHONWARNINGS="ignore:invalid escape sequence"
        export PATH="${CLANG_BIN_PATH}:$PATH"
        export LLVM=1 LLVM_IAS=1
        export ARCH=arm64 SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-android-
        export CROSS_COMPILE_COMPAT=arm-linux-androideabi-
        
        # Use LLVM tools if available
        if command -v llvm-ar >/dev/null 2>&1; then
          export AR=llvm-ar NM=llvm-nm OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump STRIP=llvm-strip
        fi
        
        export LD=ld.lld HOSTLD=ld.lld HOSTCC=clang HOSTCXX=clang++ CC=clang
        
        OUT=out
        mkdir -p "$OUT"
        
        # Generate base config
        make O="$OUT" gki_defconfig
        
        # Apply custom localversion
        if [ -n "${CUSTOM_LOCALVERSION}" ]; then
          scripts/config --file "$OUT/.config" --set-str LOCALVERSION "${CUSTOM_LOCALVERSION}"
          scripts/config --file "$OUT/.config" -d LOCALVERSION_AUTO
        fi
        
        # Disable KUnit test configs to speed up build
        disable_list=(
          CONFIG_REGMAP_KUNIT
          CONFIG_INPUT_KUNIT_TEST
          CONFIG_SND_SOC_TOPOLOGY_KUNIT_TEST
          CONFIG_SND_SOC_UTILS_KUNIT_TEST
          CONFIG_HID_KUNIT_TEST
          CONFIG_RTC_LIB_KUNIT_TEST
          CONFIG_CLK_KUNIT_TEST
          CONFIG_CLK_GATE_KUNIT_TEST
          CONFIG_IIO_FORMAT_KUNIT_TEST
          CONFIG_EXT4_KUNIT_TESTS
          CONFIG_FAT_KUNIT_TEST
        )
        for sym in "${disable_list[@]}"; do
          scripts/config --file "$OUT/.config" -d "$sym" || true
        done
        
        # Regenerate config with all changes
        make O="$OUT" olddefconfig
        
        # Set compiler flags based on optimization level
        if [ "$OPTIMIZE_LEVEL" = "O3" ]; then
          KCFLAGS="-Wno-error -pipe -fno-stack-protector -O3"
        else
          KCFLAGS="-Wno-error -pipe -fno-stack-protector -O2"
        fi
        
        echo "Starting build with $(nproc) threads..."
        
        # Build kernel
        if ! make -j$(nproc) O="$OUT" KCFLAGS="$KCFLAGS" 2>&1 | tee build.log; then
          echo "::error::Build failed"
          echo "::group::Build log tail"
          tail -n 100 build.log || true
          echo "::endgroup::"
          exit 1
        fi
        
        # Verify kernel image exists
        IMG="$OUT/arch/arm64/boot/Image"
        if [ ! -f "$IMG" ]; then
          echo "::error::Image not found after build"
          ls -lh "$OUT/arch/arm64/boot/" || true
          exit 1
        fi
        
        # Check image size
        IMG_SIZE=$(($(stat -c%s "$IMG" 2>/dev/null || stat -f%z "$IMG") / 1024 / 1024))
        
        if [ "$IMG_SIZE" -lt "$MIN_IMAGE_SIZE_MB" ]; then
          echo "::error::Image too small: ${IMG_SIZE}MB (minimum: ${MIN_IMAGE_SIZE_MB}MB)"
          exit 1
        fi
        
        echo "✅ Build successful: ${IMG_SIZE}MB"
        echo "::endgroup::"
      env:
        CONFIG: ${{ inputs.model }}
        CLANG_BIN_PATH: ${{ env.CLANG_BIN_PATH }}
        CUSTOM_LOCALVERSION: ${{ env.CUSTOM_LOCALVERSION }}
        OPTIMIZE_LEVEL: ${{ inputs.optimize_level }}
        MIN_IMAGE_SIZE_MB: ${{ env.MIN_IMAGE_SIZE_MB }}

    - name: Collect Stats
      id: stats
      shell: bash
      run: |
        set -euo pipefail
        cd "$GITHUB_WORKSPACE/$CONFIG/kernel_platform/common"
        
        IMG="out/arch/arm64/boot/Image"
        if [ ! -f "$IMG" ]; then
          echo "::error::Image not found for stats"
          exit 1
        fi
        
        # Calculate SHA256
        SHA256=$(sha256sum "$IMG" | awk '{print $1}')
        
        # Get kernel release version
        KVER=$(make -s O=out kernelrelease 2>/dev/null || echo "${DETECTED_KERNEL_VERSION}")
        
        # Calculate image size
        IMG_SIZE=$(($(stat -c%s "$IMG" 2>/dev/null || stat -f%z "$IMG") / 1024 / 1024))
        
        # Output stats
        printf "image_sha256=%s\n" "${SHA256}" >> "$GITHUB_OUTPUT"
        printf "kernel_version=%s\n" "${KVER}" >> "$GITHUB_OUTPUT"
        printf "image_size=%s\n" "${IMG_SIZE}" >> "$GITHUB_OUTPUT"
        
        echo "Kernel Stats:"
        echo "  Version: $KVER"
        echo "  Size: ${IMG_SIZE}MB"
        echo "  SHA256: $SHA256"
      env:
        CONFIG: ${{ inputs.model }}
        DETECTED_KERNEL_VERSION: ${{ env.DETECTED_KERNEL_VERSION }}

    - name: Download SUSFS Module
      continue-on-error: true
      shell: bash
      run: |
        # Retry logic for fetching latest successful run
        for attempt in {1..3}; do
          LATEST_RUN_ID=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/sidex15/susfs4ksu-module/actions/runs?status=success&per_page=50" | \
            jq -r '.workflow_runs[] | select(.head_branch == "v1.5.2+") | .id' | head -n 1)
          
          [ -n "$LATEST_RUN_ID" ] && break
          echo "Attempt $attempt: No run ID found, retrying..."
          sleep 10
        done
        
        [ -z "$LATEST_RUN_ID" ] && { echo "No successful run found after 3 attempts"; exit 0; }
        
        # Get artifact download URL
        ARTIFACT_URL=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
          "https://api.github.com/repos/sidex15/susfs4ksu-module/actions/runs/$LATEST_RUN_ID/artifacts" | \
          jq -r '.artifacts[0].archive_download_url // empty')
        
        if [ -n "$ARTIFACT_URL" ]; then
          curl -fsSL -H "Authorization: Bearer $GITHUB_TOKEN" \
            -o ksu_module_susfs_1.5.2+_CI.zip "$ARTIFACT_URL"
          cp ksu_module_susfs_1.5.2+_CI.zip ./AnyKernel3/
          echo "✅ SUSFS module downloaded"
        fi
      env:
        GITHUB_TOKEN: ${{ inputs.github_token }}

    - name: Create Package
      id: package
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Create package"
        
        WORK_DIR="$GITHUB_WORKSPACE/$MODEL"
        AK3_DIR="$GITHUB_WORKSPACE/AnyKernel3"
        
        # Find kernel Image
        image_path=$(find "$WORK_DIR/kernel_platform" -path "*/out/arch/arm64/boot/Image" -type f | head -n1)
        
        if [ -z "$image_path" ] || [ ! -f "$image_path" ]; then
          echo "::error::Image not found in $WORK_DIR/kernel_platform"
          find "$WORK_DIR/kernel_platform" -name "Image" -type f || true
          exit 1
        fi
        
        echo "Found Image: $image_path"
        cp "$image_path" "$AK3_DIR/Image"
        
        # Generate package names
        PACKAGE_NAME="AnyKernel3_${MODEL}_${KANDROID_VERSION}-${DETECTED_KERNEL_VERSION}_SukiSU_${KSUVER}"
        ARTIFACT_NAME="kernel-${MODEL}-${BUILD_DATE}"
        
        mkdir -p "$WORK_DIR/artifacts"
        
        cd "$AK3_DIR"
        
        # Clean up unnecessary files
        rm -rf .git .github *.md *.txt 2>/dev/null || true
        
        echo "Creating package: ${PACKAGE_NAME}.zip"
        
        # Create zip with explicit file list
        zip -r9 "$WORK_DIR/artifacts/${PACKAGE_NAME}.zip" \
          Image anykernel.sh tools/ META-INF/ \
          -x "*.git/*" -x "*.github/*" 2>&1
        
        # Add SUSFS module if exists
        if [ -f "ksu_module_susfs_1.5.2+_CI.zip" ]; then
          cd "$WORK_DIR/artifacts"
          unzip -q "${PACKAGE_NAME}.zip" -d temp_extract
          cp "$AK3_DIR/ksu_module_susfs_1.5.2+_CI.zip" temp_extract/
          cd temp_extract
          zip -r9 "../${PACKAGE_NAME}.zip" . -x "*.git/*" -x "*.github/*"
          cd ..
          rm -rf temp_extract
          echo "✅ SUSFS module included in package"
        fi
        
        PKG_PATH="$WORK_DIR/artifacts/${PACKAGE_NAME}.zip"
        
        if [ ! -f "$PKG_PATH" ]; then
          echo "::error::Package not created: $PKG_PATH"
          ls -lR "$WORK_DIR/artifacts/" || true
          exit 1
        fi
        
        PKG_SIZE=$(($(stat -c%s "$PKG_PATH" 2>/dev/null || stat -f%z "$PKG_PATH") / 1024 / 1024))
        
        echo "✅ Package created: ${PKG_SIZE}MB"
        echo "Package location: $PKG_PATH"
        
        # Output relative path
        RELATIVE_PATH="${MODEL}/artifacts/${PACKAGE_NAME}.zip"
        
        printf "name=%s\n" "${PACKAGE_NAME}" >> "$GITHUB_OUTPUT"
        printf "artifact_name=%s\n" "${ARTIFACT_NAME}" >> "$GITHUB_OUTPUT"
        printf "size=%s\n" "${PKG_SIZE}" >> "$GITHUB_OUTPUT"
        printf "path=%s\n" "${RELATIVE_PATH}" >> "$GITHUB_OUTPUT"
        printf "filename=%s\n" "${PACKAGE_NAME}.zip" >> "$GITHUB_OUTPUT"
        
        echo "::endgroup::"
      env:
        MODEL: ${{ inputs.model }}
        KANDROID_VERSION: ${{ inputs.android_version }}
        DETECTED_KERNEL_VERSION: ${{ env.DETECTED_KERNEL_VERSION }}
        KSUVER: ${{ env.KSUVER }}
        BUILD_DATE: ${{ env.BUILD_DATE }}

    - name: Verify Package
      shell: bash
      run: |
        set -euo pipefail
        
        PKG_PATH="$GITHUB_WORKSPACE/$MODEL/artifacts/${PACKAGE_NAME}.zip"
        
        if [ ! -f "$PKG_PATH" ]; then
          echo "::error::Package verification failed!"
          echo "Expected: $PKG_PATH"
          echo ""
          echo "Directory contents:"
          ls -lR "$GITHUB_WORKSPACE/$MODEL/artifacts/" || echo "artifacts/ directory missing"
          exit 1
        fi
        
        # Test zip integrity
        if ! unzip -t "$PKG_PATH" >/dev/null 2>&1; then
          echo "::error::Package is corrupted!"
          exit 1
        fi
        
        # Verify Image is inside
        if ! unzip -l "$PKG_PATH" | grep -q "Image"; then
          echo "::error::Package missing kernel Image!"
          unzip -l "$PKG_PATH"
          exit 1
        fi
        
        echo "✅ Package verified successfully"
      env:
        MODEL: ${{ inputs.model }}
        PACKAGE_NAME: ${{ steps.package.outputs.name }}

    - name: Generate Release Tag
      id: generate_tag
      shell: bash
      run: |
        TAG="${MODEL}-${BUILD_DATE}"
        printf "tag=%s\n" "${TAG}" >> "$GITHUB_OUTPUT"
      env:
        MODEL: ${{ inputs.model }}
        BUILD_DATE: ${{ env.BUILD_DATE }}

    - name: Generate Release Notes
      shell: bash
      run: |
        cat > "$GITHUB_WORKSPACE/RELEASE_NOTES.md" << EOF
        ## ${{ inputs.model }} - ${{ inputs.android_version }}
        
        **Kernel:** \`${{ steps.stats.outputs.kernel_version }}\`  
        **KernelSU:** \`${{ env.KSUVER }}\`  
        **SUSFS:** \`${{ env.SUSVER }}\`  
        **Hook:** \`${{ env.HOOK_TYPE }}\`  
        **Optimization:** \`${{ inputs.optimize_level }}\`  
        **Date:** \`${{ env.BUILD_DATE }}\`
        
        **SHA256:** \`${{ steps.stats.outputs.image_sha256 }}\`
        
        Flash via TWRP/OrangeFox recovery.
        EOF

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.package.outputs.artifact_name }}
        path: ${{ steps.package.outputs.path }}
        compression-level: 0
        if-no-files-found: error
        retention-days: 30

    - name: Cleanup Temporary Files
      if: always()
      shell: bash
      run: |
        cd "$CONFIG/kernel_platform/common" 2>/dev/null || exit 0
        rm -f build.log *.patch 2>/dev/null || true
        
        cd "$CONFIG" 2>/dev/null || exit 0
        rm -rf susfs4ksu SukiSU_patch 2>/dev/null || true
        
        echo "✅ Temporary files cleaned up"
      env:
        CONFIG: ${{ inputs.model }}

    - name: Cleanup Git Config
      if: always()
      shell: bash
      run: |
        git config --global --unset user.name || true
        git config --global --unset user.email || true
        git config --global --unset advice.detachedHead || true

    - name: Summary
      if: always()
      shell: bash
      run: |
        if [ "${{ steps.build.outcome }}" = "success" ]; then
          echo "✅ **${{ inputs.model }}** - Build Success" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|----------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Kernel | \`${{ steps.stats.outputs.kernel_version }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| KSU | \`${{ env.KSUVER }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| SUSFS | \`${{ env.SUSVER }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Hook | \`${{ env.HOOK_TYPE }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Optimization | \`${{ inputs.optimize_level }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Package | \`${{ steps.package.outputs.name }}.zip\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Size | \`${{ steps.package.outputs.size }}MB\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Artifact | \`${{ steps.package.outputs.artifact_name }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| SHA256 | \`${{ steps.stats.outputs.image_sha256 }}\` |" >> "$GITHUB_STEP_SUMMARY"
        else
          echo "❌ **${{ inputs.model }}** - Build Failed" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Check the logs above for error details." >> "$GITHUB_STEP_SUMMARY"
        fi
